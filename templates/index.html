<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VX153VVW52"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-VX153VVW52');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unmatched Fighter Chooser</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>

{% macro render_fighter_card(fighter, is_main, player_prefix, locked_id, vs_fighter) %}
    {% if fighter %}
        {# Determine button type and card classes based on context #}
        {% set card_id_attr = 'id="' ~ player_prefix ~ '-main-suggestion"' if is_main else '' %}
        {% set card_cls = "main-suggestion" if is_main else "alternative-suggestion" %}
        {% set is_locked = fighter.id and fighter.id == locked_id %}

        <div {{ card_id_attr | safe }} class="fighter-card {{ card_cls }}" data-fighter-id="{{ fighter.id }}" data-player-prefix="{{ player_prefix }}">
            <div class="fighter-card-body">
                <img src="{{ url_for('static', filename=fighter.image_url.replace('/static/', '')) }}" alt="{{ fighter.name }}" class="fighter-image" onerror="this.onerror=null;this.src='https://placehold.co/100x150/e9ecef/6c757d?text={{ fighter.name | urlencode }}';">
                <div class="fighter-details">
                    <h3 class="fighter-name">{{ fighter.name }}</h3>
                    <p><strong>Set:</strong> {{ fighter.set }}</p>
                    <p><strong>Range:</strong> {{ fighter.range | titlecase_custom }}</p>
                    <p><strong>Playstyles:</strong> {{ fighter.playstyles | map('titlecase_custom') | join(', ') }}</p>

                    {# Win percentage logic #}
                    <p class="win-percentage-text">
                    {% if vs_fighter %}
                        {% set win_pct = calculate_win_percentage(fighter.id, vs_fighter.id) %}
                        <strong>Win vs {{ vs_fighter.name }}:</strong> {{ win_pct }}%
                    {% endif %}
                    </p>
                </div>
            </div>
            <div class="fighter-card-footer">
                {# Main Card: Show a lock/unlock button (as a proper form submission) #}
                {% if is_main %}
                    {% if is_locked %}
                        <button type="submit" name="action" value="unlock_{{ player_prefix }}" class="lock-button btn-unlock">üîì Fighter Locked</button>
                    {% else %}
                        <button type="submit" name="action" value="lock_{{ player_prefix }}:{{ fighter.id }}" class="lock-button btn-lock">üîí Lock Fighter</button>
                    {% endif %}
                {# Alternative Card: Show a JS-only select button #}
                {% else %}
                    <button type="button" class="select-alternative-btn">Select for Matchup</button>
                {% endif %}
            </div>
        </div>
    {% endif %}
{% endmacro %}


<header>
    <h1>Unmatched Fighter Chooser üß≠</h1>
    <p>Select sets, choose or get suggestions, and find your perfect Unmatched battle!</p>
</header>

<main>
<form id="fighter-chooser-form" method="POST" action="{{ url_for('index') }}">
    <input type="hidden" id="current_locked_p1_id"  name="current_locked_p1_id"
           value="{{ selected_data.locked_p1_id if selected_data.locked_p1_id else '' }}">
    <input type="hidden" id="current_locked_opp_id" name="current_locked_opp_id"
           value="{{ selected_data.locked_opp_id if selected_data.locked_opp_id else '' }}">

    <section class="settings-panel">
        <div class="header-with-help">
            <h2>Game Setup</h2>
            <button type="button" id="intro-help-btn" class="help-icon-btn" title="Show welcome help">‚ìò</button>
        </div>
        <div class="set-selection collapsed">
            <h3>
                Owned Sets
                <button id="toggle-set-selection-btn" type="button" aria-expanded="false">‚¨á Show</button>
            </h3>
            <div id="set-checkboxes" class="set-checkboxes">
                {% for set_name_iter in all_sets_list %}
                <label class="set-switch">
                    <input type="checkbox" name="owned_sets" value="{{ set_name_iter }}" {% if set_name_iter in selected_data.owned_sets %}checked{% endif %}>
                    <span class="slider"></span>
                    <span class="set-label">{{ set_name_iter }}</span>
                </label>
                {% endfor %}
            </div>
            <div class="set-actions">
                <button type="button" id="select-all-sets-btn">Select All</button>
                <button type="button" id="deselect-all-sets-btn">Deselect All</button>
            </div>
        </div>

        <!-- üîΩüîΩüîΩ NEW MATCHUP MODE BLOCK üîΩüîΩüîΩ -->
        <div id="mode-settings-panel" class="mode-selection collapsed">
            <h3>
                Matchup Mode
                <div class="header-buttons">
                    <button type="button" id="matchup-mode-help-btn" class="help-icon-btn" title="Show help">‚ìò</button>
                    <button type="button" id="show-mode-settings-btn" class="mode-toggle-heading-btn" aria-expanded="false">‚¨á Show</button>
                </div>
            </h3>
            <p class="helper-text">
                Choose how strongly the engine should prioritize <strong>fairness</strong> (balanced win rates)
                vs <strong>fit</strong> (playstyles and range). If you‚Äôre not sure, just leave this as is.
            </p>
            <div class="mode-options">
                <label>
                    <input type="radio" name="mode" value="discovery"
                           {% if selected_data.mode == 'discovery' or not selected_data.mode %}checked{% endif %}>
                    Discovery (more variety / fit)
                </label>
                <label>
                    <input type="radio" name="mode" value="fairness"
                           {% if selected_data.mode == 'fairness' %}checked{% endif %}>
                    Fairness (balanced matchups)
                </label>

                <!-- "hidden" advanced control: shows custom weight block -->
                <div class="advanced-button-row">
                    <button type="button" id="advanced-mode-toggle" class="advanced-toggle">
                        ‚öô Advanced
                    </button>
                    <button type="button" id="advanced-help-btn" class="help-icon-btn" title="Show help">‚ìò</button>
                </div>
            </div>

            <div id="custom-mode-settings" class="custom-mode collapsed">
                <label for="fairness_weight">
                    Custom fairness weight (0.0‚Äì1.0):
                </label>
                <input type="number"
                       id="fairness_weight"
                       name="fairness_weight"
                       min="0" max="1" step="0.05"
                       value="{{ selected_data.fairness_weight if selected_data.fairness_weight is not none else '' }}">
                <p class="helper-text">
                    Fit weight = 1 ‚àí fairness weight. Providing a value lets you fine-tune how ‚Äúswingy‚Äù
                    vs ‚Äúeven‚Äù you want matchups to be.
                </p>
            </div>
        </div>
        <!-- üîºüîºüîº END MATCHUP MODE BLOCK üîºüîºüîº -->
    </section>

    <section class="matchup-configuration">
        <h2>Fighter Selection</h2>
        <div class="player-columns-container">
            <div class="player-column" id="player1-controls">
                <h3>Player 1 (You)</h3>
                <div class="top-control-wrapper">
                    <label for="p1_selection_method">How to choose P1‚Äôs fighter?</label>
                    <select id="p1_selection_method" name="p1_selection_method">
                        <option value="suggest" {% if selected_data.p1_selection_method == 'suggest' %}selected{% endif %}>Suggest for Me</option>
                        <option value="direct_choice" {% if selected_data.p1_selection_method == 'direct_choice' %}selected{% endif %}>Let Me Choose</option>
                    </select>
                </div>
                <div id="p1-direct-choice-section">
                    <label for="p1_chosen_fighter">Choose Your Fighter:</label>
                    <select id="p1_chosen_fighter" name="p1_chosen_fighter">
                        <option value="">‚Äî Select a Fighter ‚Äî</option>
                        {% for fighter in all_fighters_for_select %}
                        <option value="{{ fighter.id }}" data-set="{{ fighter.set }}" {% if fighter.id|string == selected_data.p1_chosen_fighter_id %}selected{% endif %}>
                            {{ fighter.name }} ({{ fighter.set }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div id="p1-preferences-section" class="preferences-row">
                    <div class="playstyle-selector">
                        <label>Preferred Play-style(s):</label>
                        <button class="toggle-playstyle-btn" type="button" data-target="p1-playstyle-options" aria-expanded="false">Select</button>
                        <div id="p1-playstyle-options" class="playstyle-options collapsed">
                            {% for style in all_playstyles %}
                            <label><input type="checkbox" name="p1_playstyles" value="{{ style }}" {% if style in selected_data.p1_playstyles %}checked{% endif %}> {{ style | titlecase_custom }}</label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="range-selector">
                        <label for="p1_range">Preferred Range:</label>
                        <select id="p1_range" name="p1_range">
                            <option value="">Any Range</option>
                            {% for range_type in all_ranges %}
                            <option value="{{ range_type }}" {% if range_type == selected_data.p1_range %}selected{% endif %}>{{ range_type | titlecase_custom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="player-column" id="opponent-controls">
                <h3>Opponent</h3>
                <div class="top-control-wrapper spacer" aria-hidden="true"></div>
                <div class="preferences-row">
                    <div class="playstyle-selector">
                        <label>Preferred Play-style(s):</label>
                        <button class="toggle-playstyle-btn" type="button" data-target="opp-playstyle-options" aria-expanded="false">Select</button>
                        <div id="opp-playstyle-options" class="playstyle-options collapsed">
                            {% for style in all_playstyles %}
                            <label><input type="checkbox" name="opp_playstyles" value="{{ style }}" {% if style in selected_data.opp_playstyles %}checked{% endif %}> {{ style | titlecase_custom }}</label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="range-selector">
                        <label for="opp_range">Preferred Range:</label>
                        <select id="opp_range" name="opp_range">
                            <option value="">Any Range</option>
                            {% for range_type in all_ranges %}
                            <option value="{{ range_type }}" {% if range_type == selected_data.opp_range %}selected{% endif %}>{{ range_type | titlecase_custom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="action-area">
        <button id="generate-matchup-btn" class="primary-action-button" type="submit" name="action" value="suggest_general">
            üé≤ Generate Matchup!
        </button>
    </section>
</form>

{% if results and results.p1_main and results.opp_main %}
<section id="results-display-area" class="results-panel">
    <h2>Matchup Suggestion</h2>

    {% if error_message %}
    <div class="error-message active">{{ error_message }}</div>
    {% endif %}

    <div class="player-columns-container">
        <div class="player-column results-column">
            <h4>Player 1‚Äôs Fighter</h4>
            {{ render_fighter_card(results.p1_main, True, 'p1', selected_data.locked_p1_id, results.opp_main) }}

            {% if results.p1_alternatives %}
            <h5>Alternatives:</h5>
            <div class="alternatives-grid">
                {% for fighter in results.p1_alternatives %}
                    {{ render_fighter_card(fighter, False, 'p1', None, results.opp_main) }}
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="player-column results-column">
            <h4>Opponent‚Äôs Fighter</h4>
            {{ render_fighter_card(results.opp_main, True, 'opp', selected_data.locked_opp_id, results.p1_main) }}

            {% if results.opp_alternatives %}
            <h5>Alternatives:</h5>
            <div class="alternatives-grid">
                {% for fighter in results.opp_alternatives %}
                    {{ render_fighter_card(fighter, False, 'opp', None, results.p1_main) }}
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
</section>
{% endif %}
</main>

<footer>
    <p>Unmatched Fighter Chooser ‚Äî Powered by Flask &amp; Your Preferences!</p>
</footer>

<!-- Cookie consent banner -->
<div id="cookie-consent" class="cookie-consent hidden" role="dialog" aria-live="polite" aria-label="Cookie consent">
    <div class="cookie-text">
        We use cookies to remember your choices and, with your permission, collect anonymous analytics about button clicks and options you select. This data is only used to understand behavior and improve the site experience.
    </div>
    <div class="cookie-actions">
        <button type="button" id="cookie-accept">Accept cookies</button>
        <button type="button" id="cookie-decline" class="secondary">Decline</button>
    </div>
</div>

<!-- Intro popup: shown once on first visit -->
<div id="intro-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Welcome to Unmatched Fighter Chooser üß≠</h2>
        <p>
            This tool helps you find fun and balanced <strong>Unmatched</strong> matchups
            based on the sets you own, playstyles and ranges.
        </p>
        <p>
            <strong>How to use it:</strong><br>
            1) Select the sets you own.<br>
            2) Click ‚ÄúGenerate Matchup‚Äù to get a suggested fighter for you and a pool of alternatives.<br>
            3) Pick a fighter you like for Player 1 and <strong>lock</strong> them.<br>
            4) Run ‚ÄúGenerate Matchup‚Äù again with your fighter locked to get a much more accurate opponent suggestion and pools.
        </p>
        <button type="button" id="intro-modal-close">Got it!</button>
    </div>
</div>

<!-- Matchup Mode help popup: shown when Show button is clicked -->
<div id="matchup-mode-help-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Matchup Mode Explained üéÆ</h2>
        <p>
            <strong>Discovery Mode:</strong> The engine prioritizes finding fighters that match your
            playstyle and range preferences. Great for exploring different fighter combinations.
        </p>
        <p>
            <strong>Fairness Mode:</strong> The engine tries much harder to keep matchups close to a
            50/50 win rate using the internal win-rate matrix. Perfect when you want competitive balance.
        </p>
        <p>
            <strong>Advanced:</strong> Fine-tune the exact balance between fairness and fit using a custom weight.
        </p>
        <button type="button" id="matchup-mode-help-close">Got it!</button>
    </div>
</div>

<!-- Advanced mode popup: shown when Advanced button is clicked -->
<div id="advanced-mode-help-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>Advanced: Custom Weight üéõÔ∏è</h2>
        <p>
            Use the custom weight slider to control the balance between <strong>fairness</strong> and <strong>fit</strong>.
        </p>
        <p>
            <strong>0.0</strong> = 100% fit (ignore win rates, focus on playstyles and range)<br>
            <strong>0.5</strong> = 50/50 balance between fairness and fit<br>
            <strong>1.0</strong> = 100% fairness (prioritize balanced win rates)
        </p>
        <p>
            Leave it empty to use Discovery or Fairness mode instead.
        </p>
        <button type="button" id="advanced-mode-help-close">Understood!</button>
    </div>
</div>

<script>
    const ALL_FIGHTERS_JS = {{ all_fighters_for_select | tojson }};
    const WIN_MATRIX = {{ win_matrix | tojson }};
</script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
</body>
</html>
